{% extends "base.html" %}
{% load static %}

{% block content %}
{# allow either `profile_user` (from get_profile) or `user` to be used as `profile` #}
{% with profile=profile_user|default:user viewer=current_user|default:user %}
<div class="profile-page">
  <div class="profile-header-top">
    <a href="{% url 'post_list' %}" class="back-link"><i class='bx bx-arrow-back' style="font-size:24px;"></i></a>
    <div class="profile-header-title">
      <div class="profile-name">{{ profile.display_name|default:profile.username|capfirst }}</div>
      <div class="profile-count">{{ posts|length }} Posts</div>
    </div>
  </div>

  <!-- Use same header structure as post_detail (banner + overlapping avatar + meta) -->
  <div class="post-top">
    <div class="post-banner" {% if profile.cover_image %}style="background-image: url('{{ profile.cover_image.url }}'); background-size: cover; background-position: center;"{% endif %}></div>

    <div class="post-author">
      <div class="avatar-large">{{ profile.display_name|default:profile.username|first|upper }}</div>
      <div class="author-meta">
        <div class="display-name">{{ profile.display_name|default:profile.username|capfirst }}</div>
        <div class="handle">@{{ profile.username }}</div>
        {% if profile.email %}
        {% endif %}
        <div class="follow-stats">
          <div class="stat">
            <div class="stat-num">{{ posts|length }}</div>
            <div class="stat-label">Posts</div>
          </div>
          <div class="stat">
            <div class="stat-num">0</div>
            <div class="stat-label">Following</div>
          </div>
          <div class="stat">
            <div class="stat-num">0</div>
            <div class="stat-label">Followers</div>
          </div>
        </div>
      </div>

      <div class="profile-actions">
        {% if viewer and profile and viewer.id == profile.id %}
        <a href="#" class="btn btn-outline">Edit profile</a>
        {% else %}
        <a href="#" class="btn btn-primary">Follow</a>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="profile-tabs">
    <div class="tab active">Posts</div>
    <div class="tab">Media</div>
  </div>

  <div class="profile-posts">
    {% if posts %}
      {% for post in posts %}
      <article class="timeline-post card" data-post-id="{{ post.id }}">
        <div class="post-avatar">
          <div class="avatar-small">{{ post.author.display_name|default:post.author.username|first|upper }}</div>
        </div>
        <div class="post-body">
          <div class="post-header">
            <span class="username">{{ post.author.display_name|default:post.author.username|capfirst }}</span>
            <span class="handle">@{{ post.author.username }}</span>
            <span class="dot">¬∑</span>
            <span class="time">{{ post.created_at|timesince }} ago</span>
          </div>
          <div class="post-text">{{ post.content|linebreaksbr }}</div>
          <div class="post-stats">
            <button class="stat-btn comment-btn"><i class='bx bx-comment'></i> <span class="stat-count">{{ post.comments.count }}</span></button>
            <button class="stat-btn like-btn" data-liked="false"><i class='bx bx-heart'></i> <span class="stat-count">{{ post.like_count|default:0 }}</span></button>
            <button class="stat-btn reaction-btn" data-post-id="{{ post.id }}" onclick="openReactionModal({{ post.id }}, this)"><i class='bx bx-smile'></i></button>
            <button class="stat-btn"><i class='bx bx-share'></i></button>
            <div class="reaction-display" data-post-id="{{ post.id }}" aria-hidden="true"></div>
          </div>
          {% if post.image %}
          <div class="post-media"><img src="{{ post.image.url }}" alt="image"></div>
          {% endif %}
          {% if post.video %}
          <div class="post-media"><video controls src="{{ post.video.url }}"></video></div>
          {% endif %}
        </div>
      </article>
      {% endfor %}
    {% else %}
      <div class="empty-timeline">This user hasn't posted anything yet.</div>
    {% endif %}
  </div>
</div>

<style>
  /* Page container and spacing */
  .profile-page { max-width: 720px; margin: 28px auto; padding: 0 16px; }
  .profile-header-top { display:flex; align-items:center; gap:12px; padding:8px 0 16px; border-bottom:1px solid #2f3336; }
  .back-link { color:var(--text-color); text-decoration:none; font-size:22px; }
  .profile-header-title { display:flex; flex-direction:column; }
  .profile-name { font-weight:700; font-size:18px; }
  .profile-count { color:#71767b; font-size:13px; }

  /* Banner + avatar (match post_detail styles) */
  .post-banner, .banner { width:100%; height:160px; border-radius:12px; background: linear-gradient(90deg,#1d9bf0,#7856ff); box-shadow: 0 8px 28px rgba(0,0,0,0.5); margin-bottom: -56px; position:relative; overflow:hidden; }
  .post-banner::after { content: ''; position: absolute; inset: 0; background: linear-gradient(180deg, rgba(0,0,0,0.06), rgba(0,0,0,0.18)); }
  .post-top { position: relative; margin-bottom: 18px; }
  .post-author { display:flex; align-items:center; gap:12px; position: relative; margin-top: -56px; padding-left: 12px; }
  .avatar-large { width:112px; height:112px; border-radius:50%; background:#0f1112; flex-shrink:0; border:4px solid var(--background-color); box-shadow:0 8px 20px rgba(0,0,0,0.5); transform: translateY(-8px); margin-left:0; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:800; font-size:36px; }
  .author-meta { color:#e7e9ea; }
  .author-meta .display-name { font-weight:800; font-size:20px; }
  .author-meta .handle { color:#b9bfc3; margin-top:4px; font-size:13px; }

  /* make the posts sit nicely under the banner like the post_detail page */
  .timeline-post.card { margin-top: 8px; border-radius:12px; overflow:visible; }

  /* Meta and actions */
  .profile-meta { flex:1; padding-top:6px; }
  .display-name { font-size:20px; font-weight:700; }
  .handle { color:#71767b; margin-top:4px; }
  .bio { margin-top:8px; color:#e7e9ea; }
  .follow-stats { display:flex; gap:18px; margin-top:12px; color:#e7e9ea; align-items:center; }
  .follow-stats .stat { display:flex; flex-direction:column; align-items:flex-start; }
  .follow-stats .stat-num { font-size:16px; color:#e7e9ea; }
  .follow-stats .stat-label { font-size:12px; color:#9aa0a6; margin-top:2px; }
  .profile-actions { position:absolute; right:16px; top:72px; }
  .btn { padding:8px 14px; border-radius:9999px; text-decoration:none; font-weight:600; font-size:14px; }
  .btn-primary { background:var(--primary-color); color:white; border: none; }
  .btn-outline { border:1px solid rgba(255,255,255,0.06); color:var(--text-color); background:transparent; }

  /* Tabs */
  .profile-tabs { display:flex; gap:12px; padding:12px 0; border-bottom:1px solid #2f3336; }
  .tab { padding:10px 0; color:#71767b; cursor:pointer; }
  .tab.active { color:var(--text-color); font-weight:700; border-bottom:2px solid var(--primary-color); }

  /* Posts */
  .profile-posts { padding-top:18px; }
  .timeline-post { display:flex; gap:12px; padding:12px 0; border-bottom:1px solid #2f3336; }
  .timeline-post.card { background: linear-gradient(180deg,#000,#050505); border-radius:12px; padding:12px; }
  .post-avatar .avatar-small, .avatar-small { width:48px; height:48px; border-radius:50%; background:#0f1112; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size:18px; }
  .post-body { flex:1; }
  /* Post header: normalized weight and sizing to match post_detail */
  .post-header { display:flex; align-items:center; gap:8px; color:#e7e9ea; font-weight:400; }
  .post-header .username { font-weight:400; font-size:15px; color:#e7e9ea; }
  .post-header .handle, .post-header .time, .post-header .dot { color:#b9bfc3; font-size:13px; font-weight:400; }
  .post-text { margin-top:6px; color:#e7e9ea; }
  .post-media img, .post-media video { width:100%; border-radius:12px; margin-top:8px; }
  .post-stats { display:flex; gap:12px; margin-top:10px; }
  .stat-btn { background: transparent; border: none; color: #9aa0a6; cursor: pointer; display:inline-flex; gap:8px; align-items:center; }
  .stat-btn .stat-count { font-weight:700; margin-left:4px; color:#c7cdd0 }
  .like-btn.liked { color: #ff4d6d; transform: scale(1.05); }
  .empty-timeline { padding:24px; color:#71767b; text-align:center; }

  /* Responsive tweaks */
  @media (max-width:640px) {
    .profile-page { padding: 0 12px; }
    .banner { height:110px; }
    .avatar-large { width:84px; height:84px; transform: translateY(-42px); }
    .profile-actions { top:56px; right:12px; }
  }

/* Reaction modal styles (shared with post_detail) */
.reaction-modal { display: none; position: fixed; inset: 0; z-index: 2000; }
.reaction-modal-backdrop { position:absolute; inset:0; background: rgba(0,0,0,0.45); }
.reaction-modal-panel { position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%) scale(0.96); background: #000; border-radius: 12px; padding: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.6); opacity: 0; transition: transform .16s ease, opacity .16s ease; }
.reaction-modal-panel.show { transform: translate(-50%,-50%) scale(1); opacity: 1; }
.reaction-grid { display:grid; grid-template-columns: repeat(6, 48px); gap:8px; }
.reaction-item { width:48px; height:48px; border-radius:10px; border:none; background: linear-gradient(180deg,#0b0b0c,#0f1112); color: #fff; font-size:20px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition: transform .12s ease; }
.reaction-item:active { transform: scale(0.92); }
.reaction-fly { position:fixed; font-size:20px; pointer-events:none; transition: transform .9s cubic-bezier(.2,.8,.2,1), opacity .9s ease; transform-origin:center; z-index:3000; }
.reaction-fly.fly { transform: translateY(-64px) scale(1.6); opacity: 0.95; }
.reaction-fly.pop { transform: translateY(-120px) scale(0.32); opacity: 0; }
.reaction-display { display:inline-flex; align-items:center; gap:6px; margin-left:8px; }
.reaction-chip { background: rgba(255,255,255,0.04); padding:6px 8px; border-radius:999px; display:inline-flex; gap:6px; align-items:center; font-weight:700; }
.reaction-chip .reaction-count { color:#c7cdd0; font-weight:700; margin-left:4px; }
.reaction-display.pulse { animation: pulseScale .6s ease; }
@keyframes pulseScale { 0%{ transform:scale(.98); } 50%{ transform:scale(1.06);} 100%{ transform:scale(1); } }
</style>
  {% endwith %}

  <!-- Reaction modal script (shared behavior) -->
  <script>
    (function(){
      let modal = null;
      function ensureModal(){
        if (modal) return modal;
        modal = document.createElement('div');
        modal.id = 'reactionModal';
        modal.className = 'reaction-modal';
        modal.innerHTML = `
          <div class="reaction-modal-backdrop" onclick="closeReactionModal()"></div>
          <div class="reaction-modal-panel" role="dialog" aria-label="Reactions">
            <div class="reaction-grid">
              <button class="reaction-item" data-reaction="‚ù§Ô∏è">‚ù§Ô∏è</button>
              <button class="reaction-item" data-reaction="üòÇ">üòÇ</button>
              <button class="reaction-item" data-reaction="üòÆ">üòÆ</button>
              <button class="reaction-item" data-reaction="üò¢">üò¢</button>
              <button class="reaction-item" data-reaction="üò°">üò°</button>
              <button class="reaction-item" data-reaction="üëç">üëç</button>
              <button class="reaction-item" data-reaction="üëé">üëé</button>
              <button class="reaction-item" data-reaction="üî•">üî•</button>
              <button class="reaction-item" data-reaction="üéâ">üéâ</button>
              <button class="reaction-item" data-reaction="üòç">üòç</button>
              <button class="reaction-item" data-reaction="üëè">üëè</button>
              <button class="reaction-item" data-reaction="üíØ">üíØ</button>
            </div>
          </div>`;
        document.body.appendChild(modal);
        modal.querySelectorAll('.reaction-item').forEach(btn => {
          btn.addEventListener('click', () => {
            const reaction = btn.dataset.reaction;
            const postId = modal.dataset.postId;
            applyReactionToPost(postId, reaction);
            animateReactionFly(btn, postId, reaction);
            closeReactionModal();
          });
        });
        return modal;
      }
      window.openReactionModal = function(postId, btn){
        const m = ensureModal();
        m.style.display = 'block';
        m.dataset.postId = postId;
        const panel = m.querySelector('.reaction-modal-panel');
        panel.classList.add('show');
        const first = m.querySelector('.reaction-item'); if (first) first.focus();
      }
      window.closeReactionModal = function(){
        const m = modal || document.getElementById('reactionModal');
        if (!m) return;
        const panel = m.querySelector('.reaction-modal-panel'); if (panel) panel.classList.remove('show');
        setTimeout(()=>{ if(m) m.style.display = 'none'; }, 160);
      }
      window.applyReactionToPost = function(postId, reaction){
        const wrapper = document.querySelector(`[data-post-id="${postId}"]`);
        if (!wrapper) return;
        let disp = wrapper.querySelector('.reaction-display');
        if (!disp){ disp = document.createElement('div'); disp.className = 'reaction-display'; const stats = wrapper.querySelector('.post-stats'); if(stats) stats.appendChild(disp); }
        const chip = document.createElement('span'); chip.className = 'reaction-chip'; chip.innerHTML = `${reaction} <span class="reaction-count">1</span>`;
        disp.innerHTML = ''; disp.appendChild(chip);
        disp.classList.add('pulse'); setTimeout(()=>disp.classList.remove('pulse'),600);
      }
      window.animateReactionFly = function(btnEl, postId, reaction){
        const rect = btnEl.getBoundingClientRect();
        const fly = document.createElement('div'); fly.className = 'reaction-fly'; fly.textContent = reaction;
        document.body.appendChild(fly);
        fly.style.left = (rect.left + rect.width/2 - 12) + 'px'; fly.style.top = (rect.top - 4) + 'px';
        requestAnimationFrame(()=> fly.classList.add('fly'));
        setTimeout(()=> fly.classList.add('pop'), 140);
        setTimeout(()=> fly.remove(), 900);
      }
    })();
  </script>

  {% endblock %}