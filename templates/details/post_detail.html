{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="main">

  <!-- Header -->
  <div class="header" style="display: flex; align-items: center; gap: 10px;">
    <a href="{% url 'post_list' %}" style="color: white; text-decoration: none;">
      <i class='bx bx-arrow-back' style="font-size: 24px;"></i>
    </a>
    <span>Post</span>
  </div>

  <!-- Post -->
  <!-- Post top: banner + author -->
  <div class="post-top">
    <div class="post-banner"></div>
    <div class="post-author">
      <div class="avatar-large">{{ post.author.username|first|upper }}</div>
      <div class="author-meta">
        <div class="display-name">{{ post.author.display_name|default:post.author.username|capfirst }}</div>
        <div class="handle">@{{ post.author.username }} · {{ post.created_at|timesince }} ago</div>
      </div>
    </div>
  </div>

  <div class="timeline-post card">
    <div class="post-content">
      <div class="post-header">
        <div class="post-title">
          <span class="username">{{ post.author.display_name|default:post.author.username|capfirst }}</span>
          <span class="handle">@{{ post.author.username }} · {{ post.created_at|timesince }} ago</span>
        </div>

        <div class="post-actions">
          <button class="stat-btn menu-btn" onclick="toggleMenu()"><i class="bx bx-dots-horizontal-rounded" aria-hidden="true"></i></button>

          <div id="postMenu" class="post-menu">
            <button class="menu-item report-btn" onclick="openReportModal()">Report</button>
            {% if user == post.author %}
            <button class="menu-item" onclick="openEditModal()">Edit</button>
            <form method="post" action="{% url 'post_delete' post.id %}">
              {% csrf_token %}
              <button type="submit" class="menu-item delete-btn">Delete</button>
            </form>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="post-text">{{ post.content }}</div>

      {% if post.image %}
      <div class="post-media">
        <img src="{{ post.image.url }}" alt="Post image">
      </div>
      {% endif %}

      {% if post.video %}
      <div class="post-media">
        <video controls>
          <source src="{{ post.video.url }}" type="video/mp4">
        </video>
      </div>
      {% endif %}

      <div class="post-stats">
        <button class="stat-btn comment-btn"><i class='bx bx-comment'></i> <span class="stat-count">{{ comments.count }}</span></button>
        <button class="stat-btn like-btn" data-liked="false"><i class='bx bx-heart'></i> <span class="stat-count">{{ post.like_count|default:0 }}</span></button>
        <button class="stat-btn"><i class='bx bx-share'></i></button>
      </div>
    </div>
  </div>

  <!-- Comments -->
  <div class="comments-section">
    <h3 class="comments-title">Replies</h3>

    {% for comment in comments %}
    <div class="comment">
      <div class="comment-left"><div class="comment-avatar">{{ comment.author.username|first|upper }}</div></div>
      <div class="comment-right">
        <div class="comment-meta">
          <span class="comment-name">{{ comment.author.display_name }}</span>
          <span class="comment-handle">@{{ comment.author.username }}</span>
          <span class="comment-time">· {{ comment.created_at|timesince }} ago</span>
        </div>

        <div class="comment-bubble">
          <div class="comment-text">{{ comment.content|linebreaks }}</div>

          {% if comment.image %}
          <div class="comment-media">
            <img src="{{ comment.image.url }}" alt="Comment image">
          </div>
          {% endif %}

          {% if comment.video %}
          <div class="comment-media">
            <video controls>
              <source src="{{ comment.video.url }}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
          </div>
          {% endif %}
          <div class="comment-actions-row">
            <button class="stat-btn comment-reply" title="Reply"><i class='bx bx-reply'></i></button>
            <button class="stat-btn comment-like" data-liked="false" title="Like"><i class='bx bx-heart'></i> <span class="stat-count">0</span></button>
            <button class="stat-btn comment-share" title="Share"><i class='bx bx-share'></i></button>
          </div>
        </div>
      </div>
    </div>
    {% empty %}
    <p class="no-comments">No replies yet. Be the first to reply.</p>
    {% endfor %}

    <!-- Reply box -->
    <div class="comment-box">
      <form method="post" action="{% url 'comment_create' post.id %}" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="comment-input-wrapper">
          <div id="commentPreview" class="comment-preview" aria-live="polite"></div>
          <textarea class="comment-input" name="content" placeholder="Post your reply"></textarea>
        </div>

        <div class="comment-controls">
          <div class="media-controls">
            <label class="media-btn" title="Add image">
              <i class='bx bx-image'></i>
              <input class="media-input" type="file" name="image" accept="image/*" hidden>
              <span class="media-thumb" aria-hidden="true"></span>
            </label>

            <label class="media-btn" title="Add video">
              <i class='bx bx-video'></i>
              <input class="media-input" type="file" name="video" accept="video/*" hidden>
            </label>
          </div>
          <div class="comment-actions">
            <button type="submit">Reply</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Modal -->
  <div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeEditModal()"><i class="bx bx-x" aria-hidden="true"></i></span>
    <form method="post" action="{% url 'post_edit' post.id %}" enctype="multipart/form-data">
      {% csrf_token %}
      <textarea name="content" id="editContent" required></textarea>

      <div class="post-actions">
        <label class="media-btn">
          <i class='bx bx-image'></i>
          <input type="file" name="image" hidden>
        </label>
        <label class="media-btn">
          <i class='bx bx-video'></i>
          <input type="file" name="video" hidden>
        </label>
        <button type="submit" class="submit-btn">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Report Modal -->
  <div id="reportModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeReportModal()"><i class="bx bx-x" aria-hidden="true"></i></span>
    <h3 style="margin-top:0;">Report Post</h3>
    <form onsubmit="submitReport(event)">
      <label for="reportReason">What's wrong with this post?</label>
      <textarea id="reportReason" name="reason" rows="4" style="width:100%; margin-top:8px; background:#000; color:#fff; border:1px solid #444; border-radius:6px; padding:8px;" required></textarea>
      <div style="text-align:right; margin-top:12px;">
        <button type="button" onclick="closeReportModal()" style="margin-right:8px;">Cancel</button>
        <button type="submit" style="background:#ff6b6b; color:#fff; border:none; padding:8px 12px; border-radius:6px;">Submit Report</button>
      </div>
    </form>
  </div>
</div>

<style>
  .timeline-post {
    display: flex;
    gap: 12px;
    padding: 16px;
    border-bottom: 1px solid #2f3336;
  }

  .post-header {
    display: flex;
    justify-content: space-between;
  }

  .card {
    background: linear-gradient(180deg,#000,#050505);
    border-radius: 12px;
    padding: 12px;
  }

  .post-left { float: left; margin-right: 12px; }

  .avatar {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #0f1112; /* dark gray tone */
    color: #fff;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:700;
    font-size:18px;
  }

  .username {
    font-weight: 700;
  }

  .handle {
    color: #71767b;
  }

  .post-text {
    margin: 10px 0;
  }

  .post-media img,
  .post-media video {
    max-width: 100%;
    border-radius: 16px;
    margin-top: 8px;
  }

  .comments-section {
    padding: 16px;
  }

  .comment {
    display: flex;
    gap: 12px;
    padding: 12px 0;
    border-bottom: 1px solid #2f3336;
  }
  .comment-left { width:44px; }
  .comment-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: #1d9bf0;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
  }

  .comment-right { flex: 1; }

  .comment-meta { font-size: 13px; color: #d7dadd; margin-bottom: 6px; }

  .comment-bubble {
    background: #0f1112; /* slightly contrasted bubble */
    border: 1px solid #1f2224;
    border-radius: 12px;
    padding: 10px 12px;
    color: #e7e9ea;
  }

  /* post menu */
  .post-actions { position: relative; }
  .post-menu {
    position: absolute;
    right: 0;
    top: 40px; /* spacing between button and menu */
    background: #0b0b0c;
    border: 1px solid #232527;
    border-radius: 8px;
    padding: 6px 6px;
    display: none;
    z-index: 20;
    min-width: 160px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.6);
    transform-origin: top right;
    transform: translateY(-6px);
    opacity: 0;
    transition: transform .12s ease, opacity .12s ease;
  }
  .post-menu.show { display: block; transform: translateY(0); opacity: 1; }

  .comment:hover .comment-bubble { box-shadow: 0 6px 18px rgba(0,0,0,0.35); }
  .comment { align-items: flex-start; }
  .comment + .comment { margin-top: 6px; }
  .comments-section { padding: 10px 16px; }
  .no-comments { color: #9aa0a6; }
  .post-menu .menu-item {
    display: block;
    background: transparent;
    color: #e6e9ea;
    border: none;
    padding: 8px 12px;
    width: 100%;
    text-align: left;
    cursor: pointer;
    border-radius: 6px;
  }
  .post-menu .menu-item:hover { background: rgba(255,255,255,0.03); }
  .post-menu .menu-item.report-btn { color: #ff6b6b; font-weight: 700; }

  /* per-comment action row */
  .comment-actions-row { display:flex; gap:12px; margin-top:8px; }
  .comment-actions-row .stat-btn { color:#9aa0a6; background:transparent; border:none; display:inline-flex; gap:6px; align-items:center; cursor:pointer; }
  .comment-actions-row .comment-like.liked { color: #ff4d6d; transform:scale(1.05); }

  

  .comment-header {
    font-size: 14px;
  }

  .comment-handle,
  .comment-time {
    color: #71767b;
  }

  .comment-text {
    margin-top: 6px;
  }

  .comment-input-wrapper textarea {
    width: 100%;
    background: transparent;
    border: none;
    color: #e7e9ea;
    resize: none;
    min-height: 80px;
  }

  .comment-actions {
    text-align: right;
  }

  .comment-actions button {
    background: #1d9bf0;
    color: white;
    border: none;
    padding: 8px 18px;
    border-radius: 9999px;
    font-weight: 700;
    margin-top: 8px;
  }

  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
  }

  .modal-content {
    background: #000;
    width: 500px;
    margin: 10% auto;
    padding: 20px;
    border-radius: 16px;
  }

  .comment-input-wrapper {
    width: 100%;
    background: transparent;
    border: #71767b 1px solid;
    border-radius: 8px;
    color: #e7e9ea;
    padding: 8px;
    display: flex;
    gap: 8px;
    align-items: flex-start;
    flex-direction: column;
  }

  .comment-input {
    text-decoration: none;
    font-size: 16px;
    margin-left: 0;
    margin-top: 0;
  }

  .comment-input:focus {
    outline: none;
  }

  /* Media controls (Twitter-style) */
  .comment-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 8px;
  }

  .media-controls {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .media-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: transparent;
    border: 1px solid transparent;
    color: #1d9bf0;
    cursor: pointer;
    transition: background .12s ease, transform .08s ease;
  }

  .media-btn:hover {
    background: rgba(29,155,240,0.12);
    transform: translateY(-1px);
  }

  .comment-preview {
    display: flex;
    gap: 8px;
    align-items: center;
    max-width: 320px;
  }

  /* post stats */
  .post-stats { display:flex; gap:12px; margin-top:10px; }
  .stat-btn { background: transparent; border: none; color: #9aa0a6; cursor: pointer; display:inline-flex; gap:8px; align-items:center; }
  .stat-btn .stat-count { font-weight:700; margin-left:4px; color:#c7cdd0 }
  .like-btn.liked { color: #ff4d6d; transform: scale(1.05); }

  /* Thumbnail inside the media button */
  .media-thumb {
    display: none;
    position: absolute;
    inset: 4px;
    border-radius: 8px;
    background-size: cover;
    background-position: center center;
    width: calc(100% - 8px);
    height: calc(100% - 8px);
    pointer-events: none;
  }

  .media-btn { position: relative; }

  .media-btn .bx { font-size: 18px; }

  .preview-item {
    position: relative;
    width: 96px;
    height: 96px;
    border-radius: 12px;
    overflow: hidden;
    background: #0f1112;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .preview-item img,
  .preview-item video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .comment-media img,
  .comment-media video {
    max-width: 100%;
    border-radius: 12px;
    margin-top: 8px;
    display: block;
  }

  .remove-preview {
    position: absolute;
    top: 6px;
    right: 6px;
    background: rgba(0,0,0,0.6);
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }

  /* New Twitter-like banner + avatar styles */
  .post-top { position: relative; margin-bottom: 18px; }
  .post-banner { width: 100%; height: 160px; border-radius: 12px; background: linear-gradient(90deg,#1d9bf0,#7856ff); box-shadow: 0 8px 28px rgba(0,0,0,0.5); }
  .post-author { display:flex; align-items:center; gap:12px; position: relative; margin-top: -56px; padding-left: 12px; }
  .avatar-large { width:112px; height:112px; border-radius:50%; background:#0f1112; color:#fff; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:36px; border:4px solid var(--background-color); box-shadow:0 8px 20px rgba(0,0,0,0.5); }
  .author-meta { color:#e7e9ea; }
  .author-meta .display-name { font-weight:800; font-size:20px; }
  .author-meta .handle { color:#b9bfc3; margin-top:4px; font-size:13px; }
  .post-title .username { font-weight:700; }

  /* Make the card sit nicely under the banner */
  .timeline-post.card { margin-top: 8px; border-radius:12px; overflow:visible; }

  @media (max-width:640px) {
    .post-banner { height:110px; }
    .avatar-large { width:84px; height:84px; font-size:28px; margin-left:8px; }
    .post-author { margin-top: -42px; }
  }
</style>

<script>
  const menu = document.getElementById('postMenu');

  function toggleMenu() {
    menu.classList.toggle('show');
  }

  function openEditModal() {
    document.getElementById('editModal').style.display = 'block';
    document.getElementById('editContent').value = "{{ post.content|escapejs }}";
  }

  function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
  }

  window.onclick = function (e) {
    if (e.target.id === 'editModal') closeEditModal();
    if (e.target.id === 'reportModal') closeReportModal();
  }

  // Comment media preview handlers
  (function () {
    const previewContainer = document.getElementById('commentPreview');
    const mediaInputs = document.querySelectorAll('.media-input');
    const selected = { image: null, video: null };

    function clearPreview(type) {
      if (!previewContainer) return;
      const item = previewContainer.querySelector('[data-type="' + type + '"]');
      if (item) {
        const el = item.querySelector('img,video');
        if (el && el.src) URL.revokeObjectURL(el.src);
        item.remove();
      }
      selected[type] = null;
      // Also clear the actual input value
      const inp = document.querySelector('.media-input[name="' + type + '"]');
      if (inp) inp.value = '';
      // also clear the thumbnail inside the image button if present
      if (type === 'image') {
        const imgInput = document.querySelector('.media-input[name="image"]');
        if (imgInput) {
          const label = imgInput.closest('label.media-btn');
          if (label) {
            const thumb = label.querySelector('.media-thumb');
            if (thumb) {
              if (thumb.dataset.objectUrl) URL.revokeObjectURL(thumb.dataset.objectUrl);
              thumb.style.backgroundImage = '';
              thumb.style.display = 'none';
              delete thumb.dataset.objectUrl;
            }
            const icon = label.querySelector('i');
            if (icon) icon.style.opacity = '';
          }
        }
      }
    }

    function renderPreview(file, type) {
      if (!previewContainer) return;
      clearPreview(type);

      const url = URL.createObjectURL(file);
      const wrapper = document.createElement('div');
      wrapper.className = 'preview-item';
      wrapper.setAttribute('data-type', type);

      if (type === 'image') {
        const img = document.createElement('img');
        img.src = url;
        img.alt = file.name;
        wrapper.appendChild(img);
      } else if (type === 'video') {
        const vid = document.createElement('video');
        vid.src = url;
        vid.controls = false;
        wrapper.appendChild(vid);
      }

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'remove-preview';
      removeBtn.innerHTML = '<i class="bx bx-x" aria-hidden="true"></i>';
      removeBtn.title = 'Remove';
      removeBtn.addEventListener('click', () => clearPreview(type));
      wrapper.appendChild(removeBtn);

      previewContainer.appendChild(wrapper);
      selected[type] = { file, url };
    }

    mediaInputs.forEach(inp => {
      inp.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        // determine type from input name
        const type = inp.name; // 'image' or 'video'
        // basic validation: limit size to 20MB for videos, 5MB for images (optional)
        const maxSize = type === 'video' ? 20 * 1024 * 1024 : 5 * 1024 * 1024;
        if (file.size > maxSize) {
          alert('File is too large. Choose a smaller file.');
          inp.value = '';
          return;
        }
        renderPreview(file, type);

        // If this is the image input, also show a tiny thumbnail inside the button
        try {
          const label = inp.closest('label.media-btn');
            if (type === 'image' && label) {
            const url = URL.createObjectURL(file);
            let thumb = label.querySelector('.media-thumb');
            if (!thumb) {
              thumb = document.createElement('span');
              thumb.className = 'media-thumb';
              label.appendChild(thumb);
            }
            thumb.style.backgroundImage = `url(${url})`;
            thumb.style.display = 'block';
            // hide icon when thumbnail visible
            const icon = label.querySelector('i');
            if (icon) icon.style.opacity = '0';
            // store the object URL so we can revoke later when clearing
            thumb.dataset.objectUrl = url;

            // Also render a small inline preview inside the input wrapper (so the image appears "in the input box")
            const previewContainer = document.getElementById('commentPreview');
            if (previewContainer) {
              // remove any existing inline image preview
              const existing = previewContainer.querySelector('[data-type="image-inline"]');
              if (existing) {
                const img = existing.querySelector('img');
                if (img && img.src) URL.revokeObjectURL(img.src);
                existing.remove();
              }
              const wrapper = document.createElement('div');
              wrapper.className = 'preview-item';
              wrapper.setAttribute('data-type', 'image-inline');
              const img = document.createElement('img');
              img.src = url;
              img.alt = file.name;
              wrapper.appendChild(img);
              const removeBtn = document.createElement('button');
              removeBtn.type = 'button';
              removeBtn.className = 'remove-preview';
              removeBtn.innerHTML = '<i class="bx bx-x" aria-hidden="true"></i>';
              removeBtn.title = 'Remove';
              removeBtn.addEventListener('click', () => clearPreview('image'));
              wrapper.appendChild(removeBtn);
              previewContainer.appendChild(wrapper);
            }
          }
        } catch (err) {
          console.warn('Could not set button thumbnail', err);
        }
      });
    });
  })();

  // Like button toggle (client-side)
  (function(){
    const likeBtn = document.querySelector('.like-btn');
    if (!likeBtn) return;
    likeBtn.addEventListener('click', function(){
      const liked = likeBtn.classList.toggle('liked');
      const countEl = likeBtn.querySelector('.stat-count');
      let count = parseInt(countEl ? countEl.innerText : '0', 10) || 0;
      count = liked ? count + 1 : Math.max(0, count - 1);
      if (countEl) countEl.innerText = count;
      // optimistic UI only — server update not implemented here
    });
  })();

  // per-comment like toggles (delegation)
  (function(){
    document.addEventListener('click', function(e){
      const likeBtn = e.target.closest('.comment-like');
      if (!likeBtn) return;
      const liked = likeBtn.classList.toggle('liked');
      const countEl = likeBtn.querySelector('.stat-count');
      let count = parseInt(countEl ? countEl.innerText : '0', 10) || 0;
      count = liked ? count + 1 : Math.max(0, count - 1);
      if (countEl) countEl.innerText = count;
    });
  })();

  // Report modal handlers
  function openReportModal() {
    const m = document.getElementById('reportModal');
    if (m) m.style.display = 'block';
  }
  function closeReportModal() {
    const m = document.getElementById('reportModal');
    if (m) m.style.display = 'none';
  }

  function submitReport(e) {
    // basic client-side confirm; real endpoint should handle the report.
    e.preventDefault();
    const reason = document.getElementById('reportReason').value.trim();
    if (!reason) { alert('Please describe the problem before reporting.'); return; }
    alert('Report submitted — thank you.');
    closeReportModal();
  }
</script>

{% endblock %}