{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="main">

  <!-- Header -->
  <div class="header" style="display: flex; align-items: center; gap: 10px;">
    <a href="{% url 'post_list' %}" style="color: white; text-decoration: none;">
      <i class='bx bx-arrow-back' style="font-size: 24px;"></i>
    </a>
    <span>Post</span>
  </div>

  <!-- Post -->
    <div class="timeline-post">
    <div class="avatar"></div>

    <div class="post-content">
      <div class="post-header">
        <div>
          <span class="username">{{ post.author.display_name }}</span>
          <span class="handle">@{{ post.author.username }} · {{ post.created_at|timesince }} ago</span>
        </div>

        <div class="post-actions">
          <button class="stat-btn menu-btn" onclick="toggleMenu()">⋯</button>

          <div id="postMenu" class="post-menu">
            <button class="menu-item">Report</button>
            {% if user == post.author %}
            <button class="menu-item" onclick="openEditModal()">Edit</button>
            <form method="post" action="{% url 'post_delete' post.id %}">
              {% csrf_token %}
              <button type="submit" class="menu-item delete-btn">Delete</button>
            </form>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="post-text">{{ post.content }}</div>

      {% if post.image %}
      <div class="post-media">
        <img src="{{ post.image.url }}" alt="Post image">
      </div>
      {% endif %}

      {% if post.video %}
      <div class="post-media">
        <video controls>
          <source src="{{ post.video.url }}" type="video/mp4">
        </video>
      </div>
      {% endif %}

      <div class="post-stats">
        <button class="stat-btn"><i class='bx bx-comment'></i> {{ comments.count }}</button>
        <button class="stat-btn"><i class='bx bx-heart'></i> {{ post.like_count|default:0 }}</button>
      </div>
    </div>
  </div>

  <!-- Comments -->
  <div class="comments-section">
    <h3 class="comments-title">Replies</h3>

    {% for comment in comments %}
    <div class="comment">
      <div class="comment-avatar">
        {{ comment.author.username|first|upper }}
      </div>

      <div class="comment-body">
        <div class="comment-header">
          <span class="comment-name">{{ comment.author.display_name }}</span>
          <span class="comment-handle">@{{ comment.author.username }}</span>
          <span class="comment-time">· {{ comment.created_at|timesince }} ago</span>
        </div>

        <div class="comment-text">
          {{ comment.content|linebreaks }}

          {% if comment.image %}
          <div class="comment-media">
            <img src="{{ comment.image.url }}" alt="Comment image">
          </div>
          {% endif %}

          {% if comment.video %}
          <div class="comment-media">
            <video controls>
              <source src="{{ comment.video.url }}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% empty %}
    <p class="no-comments">No replies yet. Be the first to reply.</p>
    {% endfor %}

    <!-- Reply box -->
    <div class="comment-box">
      <form method="post" action="{% url 'comment_create' post.id %}" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="comment-input-wrapper">
          <div id="commentPreview" class="comment-preview" aria-live="polite"></div>
          <textarea class="comment-input" name="content" placeholder="Post your reply"></textarea>
        </div>

        <div class="comment-controls">
          <div class="media-controls">
            <label class="media-btn" title="Add image">
              <i class='bx bx-image'></i>
              <input class="media-input" type="file" name="image" accept="image/*" hidden>
              <span class="media-thumb" aria-hidden="true"></span>
            </label>

            <label class="media-btn" title="Add video">
              <i class='bx bx-video'></i>
              <input class="media-input" type="file" name="video" accept="video/*" hidden>
            </label>
          </div>
          <div class="comment-actions">
            <button type="submit">Reply</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeEditModal()">&times;</span>
    <form method="post" action="{% url 'post_edit' post.id %}" enctype="multipart/form-data">
      {% csrf_token %}
      <textarea name="content" id="editContent" required></textarea>

      <div class="post-actions">
        <label class="media-btn">
          <i class='bx bx-image'></i>
          <input type="file" name="image" hidden>
        </label>
        <label class="media-btn">
          <i class='bx bx-video'></i>
          <input type="file" name="video" hidden>
        </label>
        <button type="submit" class="submit-btn">Save</button>
      </div>
    </form>
  </div>
</div>

<style>
  .timeline-post {
    display: flex;
    gap: 12px;
    padding: 16px;
    border-bottom: 1px solid #2f3336;
  }

  .post-header {
    display: flex;
    justify-content: space-between;
  }

  .username {
    font-weight: 700;
  }

  .handle {
    color: #71767b;
  }

  .post-text {
    margin: 10px 0;
  }

  .post-media img,
  .post-media video {
    max-width: 100%;
    border-radius: 16px;
  }

  .comments-section {
    padding: 16px;
  }

  .comment {
    display: flex;
    gap: 12px;
    padding: 16px 0;
    border-bottom: 1px solid #2f3336;
  }

  .comment-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: #1d9bf0;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
  }

  

  .comment-header {
    font-size: 14px;
  }

  .comment-handle,
  .comment-time {
    color: #71767b;
  }

  .comment-text {
    margin-top: 6px;
  }

  .comment-input-wrapper textarea {
    width: 100%;
    background: transparent;
    border: none;
    color: #e7e9ea;
    resize: none;
    min-height: 80px;
  }

  .comment-actions {
    text-align: right;
  }

  .comment-actions button {
    background: #1d9bf0;
    color: white;
    border: none;
    padding: 8px 18px;
    border-radius: 9999px;
    font-weight: 700;
    margin-top: 8px;
  }

  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
  }

  .modal-content {
    background: #000;
    width: 500px;
    margin: 10% auto;
    padding: 20px;
    border-radius: 16px;
  }

  .comment-input-wrapper {
    width: 100%;
    background: transparent;
    border: #71767b 1px solid;
    border-radius: 8px;
    color: #e7e9ea;
    padding: 8px;
    display: flex;
    gap: 8px;
    align-items: flex-start;
    flex-direction: column;
  }

  .comment-input {
    text-decoration: none;
    font-size: 16px;
    margin-left: 0;
    margin-top: 0;
  }

  .comment-input:focus {
    outline: none;
  }

  /* Media controls (Twitter-style) */
  .comment-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 8px;
  }

  .media-controls {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .media-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: transparent;
    border: 1px solid transparent;
    color: #1d9bf0;
    cursor: pointer;
    transition: background .12s ease, transform .08s ease;
  }

  .media-btn:hover {
    background: rgba(29,155,240,0.12);
    transform: translateY(-1px);
  }

  .comment-preview {
    display: flex;
    gap: 8px;
    align-items: center;
    max-width: 320px;
  }

  /* Thumbnail inside the media button */
  .media-thumb {
    display: none;
    position: absolute;
    inset: 4px;
    border-radius: 8px;
    background-size: cover;
    background-position: center center;
    width: calc(100% - 8px);
    height: calc(100% - 8px);
    pointer-events: none;
  }

  .media-btn { position: relative; }

  .media-btn .bx { font-size: 18px; }

  .preview-item {
    position: relative;
    width: 96px;
    height: 96px;
    border-radius: 12px;
    overflow: hidden;
    background: #0f1112;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .preview-item img,
  .preview-item video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .comment-media img,
  .comment-media video {
    max-width: 100%;
    border-radius: 12px;
    margin-top: 8px;
    display: block;
  }

  .remove-preview {
    position: absolute;
    top: 6px;
    right: 6px;
    background: rgba(0,0,0,0.6);
    color: #fff;
    border: none;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }
</style>

<script>
  const menu = document.getElementById('postMenu');

  function toggleMenu() {
    menu.classList.toggle('show');
  }

  function openEditModal() {
    document.getElementById('editModal').style.display = 'block';
    document.getElementById('editContent').value = "{{ post.content|escapejs }}";
  }

  function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
  }

  window.onclick = function (e) {
    if (e.target.id === 'editModal') closeEditModal();
  }

  // Comment media preview handlers
  (function () {
    const previewContainer = document.getElementById('commentPreview');
    const mediaInputs = document.querySelectorAll('.media-input');
    const selected = { image: null, video: null };

    function clearPreview(type) {
      if (!previewContainer) return;
      const item = previewContainer.querySelector('[data-type="' + type + '"]');
      if (item) {
        const el = item.querySelector('img,video');
        if (el && el.src) URL.revokeObjectURL(el.src);
        item.remove();
      }
      selected[type] = null;
      // Also clear the actual input value
      const inp = document.querySelector('.media-input[name="' + type + '"]');
      if (inp) inp.value = '';
      // also clear the thumbnail inside the image button if present
      if (type === 'image') {
        const imgInput = document.querySelector('.media-input[name="image"]');
        if (imgInput) {
          const label = imgInput.closest('label.media-btn');
          if (label) {
            const thumb = label.querySelector('.media-thumb');
            if (thumb) {
              if (thumb.dataset.objectUrl) URL.revokeObjectURL(thumb.dataset.objectUrl);
              thumb.style.backgroundImage = '';
              thumb.style.display = 'none';
              delete thumb.dataset.objectUrl;
            }
            const icon = label.querySelector('i');
            if (icon) icon.style.opacity = '';
          }
        }
      }
    }

    function renderPreview(file, type) {
      if (!previewContainer) return;
      clearPreview(type);

      const url = URL.createObjectURL(file);
      const wrapper = document.createElement('div');
      wrapper.className = 'preview-item';
      wrapper.setAttribute('data-type', type);

      if (type === 'image') {
        const img = document.createElement('img');
        img.src = url;
        img.alt = file.name;
        wrapper.appendChild(img);
      } else if (type === 'video') {
        const vid = document.createElement('video');
        vid.src = url;
        vid.controls = false;
        wrapper.appendChild(vid);
      }

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'remove-preview';
      removeBtn.innerText = '×';
      removeBtn.title = 'Remove';
      removeBtn.addEventListener('click', () => clearPreview(type));
      wrapper.appendChild(removeBtn);

      previewContainer.appendChild(wrapper);
      selected[type] = { file, url };
    }

    mediaInputs.forEach(inp => {
      inp.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        // determine type from input name
        const type = inp.name; // 'image' or 'video'
        // basic validation: limit size to 20MB for videos, 5MB for images (optional)
        const maxSize = type === 'video' ? 20 * 1024 * 1024 : 5 * 1024 * 1024;
        if (file.size > maxSize) {
          alert('File is too large. Choose a smaller file.');
          inp.value = '';
          return;
        }
        renderPreview(file, type);

        // If this is the image input, also show a tiny thumbnail inside the button
        try {
          const label = inp.closest('label.media-btn');
          if (type === 'image' && label) {
            const url = URL.createObjectURL(file);
            let thumb = label.querySelector('.media-thumb');
            if (!thumb) {
              thumb = document.createElement('span');
              thumb.className = 'media-thumb';
              label.appendChild(thumb);
            }
            thumb.style.backgroundImage = `url(${url})`;
            thumb.style.display = 'block';
            // hide icon when thumbnail visible
            const icon = label.querySelector('i');
            if (icon) icon.style.opacity = '0';
            // store the object URL so we can revoke later when clearing
            thumb.dataset.objectUrl = url;

            // Also render a small inline preview inside the input wrapper (so the image appears "in the input box")
            const previewContainer = document.getElementById('commentPreview');
            if (previewContainer) {
              // remove any existing inline image preview
              const existing = previewContainer.querySelector('[data-type="image-inline"]');
              if (existing) {
                const img = existing.querySelector('img');
                if (img && img.src) URL.revokeObjectURL(img.src);
                existing.remove();
              }
              const wrapper = document.createElement('div');
              wrapper.className = 'preview-item';
              wrapper.setAttribute('data-type', 'image-inline');
              const img = document.createElement('img');
              img.src = url;
              img.alt = file.name;
              wrapper.appendChild(img);
              const removeBtn = document.createElement('button');
              removeBtn.type = 'button';
              removeBtn.className = 'remove-preview';
              removeBtn.innerText = '×';
              removeBtn.title = 'Remove';
              removeBtn.addEventListener('click', () => clearPreview('image'));
              wrapper.appendChild(removeBtn);
              previewContainer.appendChild(wrapper);
            }
          }
        } catch (err) {
          console.warn('Could not set button thumbnail', err);
        }
      });
    });
  })();
</script>

{% endblock %}